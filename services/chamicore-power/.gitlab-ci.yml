# TEMPLATE: GitLab CI pipeline for chamicore-power
# Copy this file and replace all __PLACEHOLDER__ markers with your service values.

stages:
  - lint
  - test
  - build
  - docker
  - release

variables:
  # Go settings.
  GOPATH: ${CI_PROJECT_DIR}/.go
  GOFLAGS: "-mod=readonly"
  # Docker settings.
  DOCKER_IMAGE: ${CI_REGISTRY_IMAGE}
  # Database for integration tests.
  POSTGRES_DB: power_test
  POSTGRES_USER: chamicore
  POSTGRES_PASSWORD: chamicore
  DB_DSN: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable"

# ---------------------------------------------------------------------------
# Cache Go modules between pipelines.
# ---------------------------------------------------------------------------
.go-cache: &go-cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-go
    paths:
      - .go/pkg/mod/
    policy: pull-push

# ===========================================================================
# Lint
# ===========================================================================
lint:
  stage: lint
  image: golangci/golangci-lint:v1.62-alpine
  <<: *go-cache
  script:
    - golangci-lint run --timeout 5m ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================================================
# Unit tests
# ===========================================================================
test:unit:
  stage: test
  image: golang:1.23-alpine
  <<: *go-cache
  script:
    - go test -race -count=1 -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 7 days
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================================================
# Integration tests (requires PostgreSQL service).
# ===========================================================================
test:integration:
  stage: test
  image: golang:1.23-alpine
  <<: *go-cache
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: power_test
    POSTGRES_USER: chamicore
    POSTGRES_PASSWORD: chamicore
  script:
    - apk add --no-cache postgresql-client
    # Wait for PostgreSQL to be ready.
    - until pg_isready -h postgres -U ${POSTGRES_USER}; do sleep 1; done
    - go test -race -count=1 -tags=integration -run Integration ./...
      -db-dsn="${DB_DSN}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ===========================================================================
# Build binary
# ===========================================================================
build:binary:
  stage: build
  image: golang:1.23-alpine
  <<: *go-cache
  script:
    - CGO_ENABLED=0 go build
      -ldflags="-s -w
        -X main.version=${CI_COMMIT_TAG:-dev}
        -X main.commit=${CI_COMMIT_SHORT_SHA}
        -X main.buildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
      -o bin/power
      ./cmd/chamicore-power
  artifacts:
    paths:
      - bin/power
    expire_in: 1 day
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ===========================================================================
# Docker image
# ===========================================================================
docker:build:
  stage: docker
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - |
      docker build \
        --build-arg VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        --build-arg COMMIT=${CI_COMMIT_SHORT_SHA} \
        --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -t ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        .
    - docker push ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}
    # Tag as latest on default branch.
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        docker tag ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE}:latest
        docker push ${DOCKER_IMAGE}:latest
      fi
    # Tag with version on tagged commits.
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE}:${CI_COMMIT_TAG}
        docker push ${DOCKER_IMAGE}:${CI_COMMIT_TAG}
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ===========================================================================
# Release (GoReleaser on tags)
# ===========================================================================
release:
  stage: release
  image: goreleaser/goreleaser:v2
  variables:
    GIT_DEPTH: 0
  script:
    - goreleaser release --clean
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
